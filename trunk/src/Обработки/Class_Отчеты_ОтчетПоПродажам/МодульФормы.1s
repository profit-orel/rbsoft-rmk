//Конфигурация для платформы "1С:Предприятие 7.7" РБ-Софт:Рабочее место кассира.
//Версия 4.43 от 19.07.10 20:54:19
//Назначение: Автоматизация POS-узлов в магазинах (Point of sale).
//(c) Баинов Евгений, ООО "РБ-Софт" 2006, г.Улан-Удэ, проспект 50-летия Октября,21А,офис 110 
//e-mail: bainov@rb-soft.ru  icq: 73718937, телефоны: (3012) 44-03-57, 44-76-42, 44-86-58
//---------------------------------------------------------------------------------------
//Данная программа является свободным программным обеспечением.
//Вы вправе распространять ее и/или модифицировать в соответствии с условиями версии 2 
//либо по вашему выбору с условиями более поздней версии Стандартной Общественной Лицензии GNU,
//опубликованной Free Software Foundation. 
//Мы распространяем данную программу в надежде на то, что она будет вам полезной, 
//однако НЕ ПРЕДОСТАВЛЯЕМ НА НЕЕ НИКАКИХ ГАРАНТИЙ, 
//в том числе ГАРАНТИИ ТОВАРНОГО СОСТОЯНИЯ ПРИ ПРОДАЖЕ
//и ПРИГОДНОСТИ ДЛЯ ИСПОЛЬЗОВАНИЯ В КОНКРЕТНЫХ ЦЕЛЯХ.
//Для получения более подробной информации ознакомьтесь со Стандартной Общественной Лицензией GNU.
//Вместе с данной программой вы должны были получить экземпляр Стандартной Общественной Лицензии GNU.
//Если вы его не получили, сообщите об этом в Free Software Foundation, Inc.,
//59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
//_______________________________________________________________________________________
Перем _База Экспорт;

Функция Этот(Конт) Возврат Конт; КонецФункции
Функция Сам() Возврат Этот(Контекст) КонецФункции

Функция Вид() Экспорт
	возврат "Отчеты.ОтчетПоПродажам";
КонецФункции	// Вид

//------------------------------------ ------------------------------------
Процедура Конструктор()
	_База = Этот(Контекст).ПолучитьБазовыйКласс("Отчеты.УниверсальныйОтчет");

	Сам=Сам();

	Сам.ДобавитьПолеОтбора("ДатаНачала","Header.Date","Дата начала",1,">=",ТекущаяДата());
	Сам.ДобавитьПолеОтбора("ДатаКонца","Header.Date","Дата конца",1,"<=",ТекущаяДата());
	Сам.ДобавитьПолеОтбора("Проведен","Header.Status","Проведен",1,"=",1);

	Сам.ДобавитьПолеОтбора("Продавец","Header.SellerID","Продавец",0,"=","","Объект.Пользователь");
	Сам.ДобавитьПолеОтбора("Кассир","Header.UserID","Кассир",0,"=","","Объект.Пользователь");

	Сам.ДобавитьПолеОтбора("НомерСмены","Header.Z","Номер смены",0,"=",0);
	Сам.ДобавитьПолеОтбора("ККМ","Header.SN","ККМ",0,"=",0);

	Сам.ДобавитьПолеОтбора("Сумма","Total","Сумма",0,">=",0,"число",15,2);
	Сам.ДобавитьПолеОтбора("Скидка","Discount","Скидка",0,">",0,"число",15,2);

	Сам.ДобавитьПолеГруппировки("Дата","Date","Дата",1);
	Сам.ДобавитьПолеГруппировки("ККМ","SN","ККМ",1);
	Сам.ДобавитьПолеГруппировки("НомерСмены","Z","Номер смены",1);
	Сам.ДобавитьПолеГруппировки("Продавец","SellerID","Продавец",1);
	Сам.ДобавитьПолеГруппировки("Чек","ID","Чек",1);
	Сам.ДобавитьПолеГруппировки("Товар","GoodID","Товар",1);

	Сам.ДобавитьПолеПоказателя("СуммаБезСкидки","Summ","Сумма без скидки",1);
	Сам.ДобавитьПолеПоказателя("Скидка","Discount","Скидка",1);
	Сам.ДобавитьПолеПоказателя("Всего","Total","Всего",1);

КонецПроцедуры // Конструктор

Функция ПолучитьИмяОткрываемойФормы(ИДФормы="ОсновнаяФорма") Экспорт
	Сам=Сам();
	Возврат "Обработка.Class_Отчеты_УниверсальныйОтчет_"+ИДФормы+"#";
КонецФункции

Функция СформироватьТекстЗапроса() Экспорт
	Сам=Сам();
	ТекстЗапроса="SELECT
	|Header.Id as ID,
	|Header.Date as Date,
	|Header.Time as Time,
	|Header.Date+Header.Time as DateTime,
	|Header.SN as SN,
	|Header.Z as Z,
	|Header.Operation as Operation,
	|Header.Num as NumCheck,
	|Header.Discrd as DiscountCard,
	|Header.Client as Client,
	|Header.SellerID as SellerID,
	|Header.SellName as SellerName,
	|Header.UserID as UserID,
	|Header.UserName as UserName,
	|Table.IdGood as IdGood,
	|Table.Name as Name,
	|Table.Count*Table.Coef as TotalCount,
	|Table.Count as Count,
	|Table.Unit as Unit,
	|Table.Coef as UnitCoef,
	|Table.Price as Price,
	|Table.Summ as Summ,
	|Table.Discount as Discount,
	|Table.Total as Total
	|From CheckT Table
	|Left Join CheckH Header
	|On Table.IDParent=Header.Id
	|";




	ДопУсловие="";
	Если Сам.СтруктураОтбора.Проведен.Использовать=1 Тогда
		ДопУсловие="(Header.Status"+Сам.СтруктураОтбора.Проведен.ТипСравнения+Сам.СтруктураОтбора.Проведен.Значение+")";
	КонецЕсли;

	Если Сам.СтруктураОтбора.ДатаНачала.Использовать=1 Тогда
		ДатаСтр=глБД.СтрокаДата(Сам.СтруктураОтбора.ДатаНачала.Значение);
		ДопУсловие=ДопУсловие+?(ДопУсловие="",""," and ")+"("+Сам.СтруктураОтбора.ДатаНачала.ИмяПоляТаблицы+Сам.СтруктураОтбора.ДатаНачала.ТипСравнения+"'"+ДатаСтр+"')";
	КонецЕсли;

	Если Сам.СтруктураОтбора.ДатаКонца.Использовать=1 Тогда
		ДатаСтр=глБД.СтрокаДата(Сам.СтруктураОтбора.ДатаКонца.Значение);
		ДопУсловие=ДопУсловие+?(ДопУсловие="",""," and ")+"("+Сам.СтруктураОтбора.ДатаКонца.ИмяПоляТаблицы+Сам.СтруктураОтбора.ДатаКонца.ТипСравнения+"'"+ДатаСтр+"')";
	КонецЕсли;

	Если Сам.СтруктураОтбора.Продавец.Использовать=1 Тогда

		ДопУсловие=ДопУсловие+?(ДопУсловие="",""," and ")+"((Header.SellerID='"+Сам.СтруктураОтбора.Продавец.Значение+"')OR((Header.SellerID='"+Сам.СтруктураОтбора.Продавец.Значение+"')AND(Header.UserID='')))";
	КонецЕсли;

	Если Сам.СтруктураОтбора.Кассир.Использовать=1 Тогда
		ДопУсловие=ДопУсловие+?(ДопУсловие="",""," and ")+"(Header.UserID='"+Сам.СтруктураОтбора.Кассир.Значение+"')";
	КонецЕсли;

	Если Сам.СтруктураОтбора.НомерСмены.Использовать=1 Тогда
		ДопУсловие=ДопУсловие+?(ДопУсловие="",""," and ")+"(Header.Z='"+Сам.СтруктураОтбора.НомерСмены.Значение+"')";
	КонецЕсли;

	Если Сам.СтруктураОтбора.ККМ.Использовать=1 Тогда
		ДопУсловие=ДопУсловие+?(ДопУсловие="",""," and ")+"(Header.SN="+Сам.СтруктураОтбора.ККМ.Значение+")";
	КонецЕсли;


	ТекстЗапроса=ТекстЗапроса+?(ДопУсловие="","","WHERE "+ДопУсловие);

	возврат ТекстЗапроса;
КонецФункции

//------------------------------------ ------------------------------------
Процедура Деструктор()

КонецПроцедуры // Деструктор

Процедура ПриОткрытии()
//#if _NOW_PREPARE_CLASS
	Форма.Параметр._ПриОткрытии(); // для отладки класса
//#endif // _NOW_PREPARE_CLASS
КонецПроцедуры // ПриОткрытии

